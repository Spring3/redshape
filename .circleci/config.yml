version: 2.1
jobs:
  lint:
    working_directory: ~/redshape
    docker:
      - image: circleci/node:14
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-{{ .Branch }}-{{ checksum "package.json" }}
      - run: 'sudo apt install libxss-dev pkg-config'
      - run: 'npm -g install node-pre-gyp'
      - run:
          name: Install Dependencies
          command: 'npm install'
      - save_cache:
          key: dependency-cache-{{ .Branch }}-{{ checksum "package.json" }}
          paths:
            - ./node_modules
      - run:
          name: 'Linting'
          command: 'npm run lint'

  test:
    working_directory: ~/redshape
    docker:
      - image: circleci/node:14
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-{{ .Branch }}-{{ checksum "package.json" }}
      - run: 'sudo apt-get update'
      - run: 'sudo apt install libxss-dev libxext-dev libxtst6 libnss3 libgtk-3-0 libgtkextra-dev libasound2'
      - run: 'npm -g install node-pre-gyp'
      - run:
          name: Install Dependencies
          command: 'npm install'
      - save_cache:
          key: dependency-cache-{{ .Branch }}-{{ checksum "package.json" }}
          paths:
            - ./node_modules
      - run:
          name: Coverage
          command: 'npm test'

  build-windows:
    working_directory: ~/redshape
    docker:
      - image: electronuserland/builder:wine
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-{{ .Branch }}-{{ checksum "package.json" }}
      - run: 'npm -g install node-pre-gyp'
      - run:
          name: Install Dependencies
          command: 'npm install'
      - save_cache:
          key: dependency-cache-{{ .Branch }}-{{ checksum "package.json" }}
          paths:
            - ./node_modules
      - run:
          name: Build
          command: |
            if [ "$CIRCLE_BRANCH" == "master" ]; then
              npm run release -- -w --ia32 --x64
            elif [ "$CIRCLE_BRANCH" == "develop" ]; then
              npm run release:ci -- -w --ia32 --x64
            else
              npm run build -- -w --ia32 --x64
            fi
      - store_artifacts:
          path: ~/redshape/build

  build-linux:
    working_directory: ~/redshape
    docker:
      - image: electronuserland/builder
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-{{ .Branch }}-{{ checksum "package.json" }}
      - run: 'npm -g install node-pre-gyp'
      - run:
          name: Install Dependencies
          command: 'npm install'
      - save_cache:
          key: dependency-cache-{{ .Branch }}-{{ checksum "package.json" }}
          paths:
            - ./node_modules
      - run:
          name: Build
          command: |
            if [ "$CIRCLE_BRANCH" == "master" ]; then
              npm run release -- -l --ia32 --x64
            elif [ "$CIRCLE_BRANCH" == "develop" ]; then
              npm run release:ci -- -l --ia32 --x64
            else
              npm run build -- -l --ia32 --x64
            fi
      - store_artifacts:
          path: ~/redshape/build

workflows:
  test:
    jobs:
      - lint
      - test
  build:
    jobs:
      - build-windows:
        filters:
          branches:
            ignore:
              - /^v\\d+\\.\\d+\\.\\d+$/
      - build-linux:
        filters:
          branches:
            ignore:
              - /^v\\d+\\.\\d+\\.\\d+$/
